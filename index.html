<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sigma - The High-Yield Lending Specialist</title>
    <meta name="description" content="AI-powered DeFi yield optimization with Gearbox Protocol. Earn rewards on idle crypto assets with leveraged yield strategies.">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#EA0890">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Brand Colors
                        brand: {
                            pink: '#EA0890',
                            green: '#22C55E',
                        },
                        // Background Hierarchy
                        bg: {
                            primary: '#141414',
                            secondary: '#19191B',
                            tertiary: '#1E1E20',
                            elevated: '#252527',
                        },
                        // Text Hierarchy
                        txt: {
                            primary: '#FFFFFF',
                            secondary: '#A1A1AA',
                            tertiary: '#71717A',
                        },
                        // Borders
                        border: {
                            default: '#27272A',
                            light: '#3F3F46',
                        }
                    }
                }
            }
        }
    </script>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Ethers.js for wallet interactions (better CDN support than wagmi/viem UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>

    <!-- API Client -->
    <script src="/api-client.js"></script>
    <script src="/web3-config.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-enter {
            animation: messageSlideIn 0.4s ease-out;
        }

        @keyframes buttonPopIn {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }
            60% {
                transform: scale(1.05) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes subtlePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(234, 8, 144, 0.4);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(234, 8, 144, 0);
            }
        }

        .button-enter {
            animation: buttonPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .button-enter:nth-child(1) { animation-delay: 0.1s; }
        .button-enter:nth-child(2) { animation-delay: 0.2s; }
        .button-enter:nth-child(3) { animation-delay: 0.3s; }
        .button-enter:nth-child(4) { animation-delay: 0.4s; }

        .strategy-button {
            animation: subtlePulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { createContext, useContext, useMemo, useState } = React;
        const { StrictMode } = React;
        const { createRoot } = ReactDOM;

        /**
         * Gearbox Strategy Agent — Full App Flow (Chat-first Fintech Dashboard)
         *
         * P0 UX Improvements Applied:
         * ✓ Input field moved to top of ChatPanel
         * ✓ Consolidated empty states with progressive disclosure
         * ✓ Collapsible sidebar design
         * ✓ Positions integrated into main flow
         * ✓ Visual template cards with icons
         * ✓ Enhanced status indicators with timestamps
         * ✓ Prominent CTAs in empty states
         * ✓ Stepped onboarding flow
         */

        /* ----------------------------
           Minimal UI primitives
           ----------------------------*/
        const Badge = ({ children, tone = "neutral" }) => {
          const toneMap = {
            neutral: "bg-gray-100 text-gray-800",
            success: "bg-green-100 text-green-800",
            warning: "bg-yellow-100 text-yellow-800",
            danger: "bg-red-100 text-red-800",
            accent: "bg-bg-elevated text-indigo-700",
          };
          return (
            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${toneMap[tone]}`}>
              {children}
            </span>
          );
        };

        const Field = ({ label, children }) => (
          <div className="flex flex-col gap-1">
            <div className="text-xs text-txt-tertiary">{label}</div>
            <div className="text-sm text-txt-primary">{children}</div>
          </div>
        );

        /* Smart Empty State - Progressive disclosure based on user journey */
        const OpportunityEmptyState = ({ hasMandate, isScanning, onCreateMandate }) => {
          if (!hasMandate) {
            return (
              <div className="flex flex-col items-center justify-center py-16 px-6 text-center">
                <div className="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center mb-4">
                  <svg className="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                </div>
                <h3 className="text-lg font-semibold text-txt-primary mb-2">Ready to Start Earning?</h3>
                <p className="text-sm text-txt-secondary max-w-md mb-6">
                  Create your first mandate to start finding high-yield opportunities. Tell the agent what you want using the assistant on the left.
                </p>
                <button
                  onClick={onCreateMandate}
                  className="px-6 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-medium"
                >
                  Create Your First Mandate
                </button>
              </div>
            );
          }

          if (isScanning) {
            return (
              <div className="flex flex-col items-center justify-center py-16 px-6 text-center">
                <div className="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center mb-4 animate-pulse">
                  <svg className="w-8 h-8 text-indigo-600 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
                <h3 className="text-lg font-semibold text-txt-primary mb-2">Scanning for Opportunities</h3>
                <p className="text-sm text-txt-secondary max-w-md">
                  Analyzing 47+ strategies across Ethereum, Base, and Arbitrum... opportunities will appear here automatically.
                </p>
              </div>
            );
          }

          return null;
        };

        /* ----------------------------
           App context
           ----------------------------*/
        const AppContext = createContext(null);
        function useApp(){ return useContext(AppContext); }
        const uid = (p = "id") => `${p}_${Math.random().toString(36).slice(2,9)}`;

        /* ----------------------------
           Chat-first onboarding
           ----------------------------*/
        function ChatPanel(){
          const { createMandateFromIntent, templates, setProposals, walletAddress, connectWallet, isWalletConnecting, openProposal, approveProposal } = useApp();
          const [messages, setMessages] = useState([
            { id: uid('m'), from: 'agent', text: "Hey, I'm Sigma — an agent created by Gearbox masterminds to automate those 'boring DeFi' high-yield lending opportunities with tokens sitting in your wallet.", showWalletConnect: !walletAddress }
          ]);
          const [input, setInput] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const [apiClient] = useState(() => new window.GearboxAPIClient());
          const [availableStrategies, setAvailableStrategies] = useState([]);
          const [suggestedTokens, setSuggestedTokens] = useState([]);
          const [walletTokenBalances, setWalletTokenBalances] = useState({}); // Store token symbol -> balance mapping

          // Dynamic quick replies - show strategies if available, then suggested tokens, otherwise show default options
          const quickReplies = availableStrategies.length > 0 ? [
            ...availableStrategies.slice(0, 3).map(strategy => ({
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: strategy.title.replace(/^(USDC|WETH|ETH)\s+/, ''), // Remove asset prefix
              description: `${strategy.projAPY}% APY`,
              isStrategy: true,
              strategy: strategy
            })),
            {
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: "Set Alert",
              description: "Notify me later",
              isAlert: true
            }
          ] : suggestedTokens.length > 0 ? [
            ...suggestedTokens.map(token => {
              // Icon mapping for different tokens
              const getTokenIcon = (token) => {
                const icons = {
                  'USDC': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                  'USDT': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                  'DAI': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                  'GHO': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><text x="12" y="16" font-size="10" text-anchor="middle" fill="currentColor">G</text></svg>',
                  'sUSDe': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><text x="12" y="16" font-size="8" text-anchor="middle" fill="currentColor">sU</text></svg>',
                  'ETH': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                  'WETH': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                  'wstETH': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                  'WBTC': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><text x="12" y="16" font-size="10" text-anchor="middle" fill="currentColor">₿</text></svg>'
                };
                return icons[token] || '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/></svg>';
              };

              return {
                iconSvg: getTokenIcon(token),
                label: token,
                description: `Search ${token} yields`,
                text: `Find me ${token} farming opportunities`,
                isToken: true
              };
            })
          ] : walletAddress ? [
            {
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 4H3C1.89543 4 1 4.89543 1 6V18C1 19.1046 1.89543 20 3 20H21C22.1046 20 23 19.1046 23 18V6C23 4.89543 22.1046 4 21 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M1 10H23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: "My Wallet",
              description: "Analyze holdings",
              text: `Analyze my wallet ${walletAddress}`
            },
            {
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: "Stablecoins",
              description: "Earn with idle USDC/USDT",
              text: "Find me the best USDC farming opportunities with low risk"
            },
            {
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: "Max Yields",
              description: "Leverage my ETH",
              text: "Show me high-yield ETH strategies with 3-5x leverage"
            }
          ] : [
            {
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: "Stablecoins",
              description: "Earn with idle USDC/USDT",
              text: "Find me the best USDC farming opportunities with low risk"
            },
            {
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: "Max Yields",
              description: "Leverage my ETH",
              text: "Show me high-yield ETH strategies with 3-5x leverage"
            },
            {
              iconSvg: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
              label: "Low Risk",
              description: "Conservative approach",
              text: "What are the safest yield strategies right now?"
            }
          ];

          function pushMessage(from, text, extraData = {}){
            setMessages(m => [...m, { id: uid('m'), from, text, ...extraData }]);
          }

          // Auto-trigger wallet analysis after connection
          React.useEffect(() => {
            window.onWalletConnected = async (address) => {
              // Add natural "connected" confirmation message with delay
              await new Promise(resolve => setTimeout(resolve, 400));
              pushMessage('agent', `Great! I can see your wallet now (${address.slice(0,6)}...${address.slice(-4)})`);

              // Add natural "thinking" message with loading state
              await new Promise(resolve => setTimeout(resolve, 1000));
              const analyzingId = uid('m');
              setMessages(m => [...m, { id: analyzingId, from: 'agent', text: 'Let me take a look at what you have...', isLoading: true }]);

              try {
                // Call AI to analyze wallet
                const response = await apiClient.sendMessage(`Analyze my wallet ${address}`);
                console.log('📨 Wallet auto-analysis response:', response);

                // Remove loading message
                setMessages(m => m.filter(msg => msg.id !== analyzingId));

                // Add analysis result
                pushMessage('agent', response.message);

                // Handle wallet tokens from response
                if (response.walletTokens && response.walletTokens.length > 0) {
                  console.log('✅ Auto-analysis wallet tokens received:', response.walletTokens);
                  const tokenSymbols = response.walletTokens.map(token => token.symbol);
                  console.log('🔄 Setting suggested tokens from auto-analysis:', tokenSymbols);
                  setSuggestedTokens(tokenSymbols);

                  // Store balances for later use
                  const balanceMap = {};
                  response.walletTokens.forEach(token => {
                    balanceMap[token.symbol] = parseFloat(token.balance).toFixed(2);
                  });
                  setWalletTokenBalances(balanceMap);
                  console.log('💰 Stored wallet token balances:', balanceMap);
                } else {
                  console.log('❌ No wallet tokens in auto-analysis response');
                }
              } catch (error) {
                setMessages(m => m.filter(msg => msg.id !== analyzingId));
                pushMessage('agent', `Sorry, I encountered an error analyzing your wallet: ${error.message}`);
              }
            };

            return () => {
              window.onWalletConnected = null;
            };
          }, [apiClient, createMandateFromIntent]);

          async function handleSend(text){
            if(!text || isLoading) return;
            pushMessage('user', text);
            setInput('');
            setIsLoading(true);

            // Show natural typing indicator with delay
            await new Promise(resolve => setTimeout(resolve, 600));
            const thinkingId = uid('m');
            const thinkingMessages = [
              'Let me check that for you...',
              'Looking into this...',
              'One moment...',
              'Give me just a second...',
              'Checking the best options...'
            ];
            const randomThinking = thinkingMessages[Math.floor(Math.random() * thinkingMessages.length)];
            setMessages(m => [...m, { id: thinkingId, from: 'agent', text: randomThinking, isLoading: true }]);

            try {
              // Call real AI agent
              const response = await apiClient.sendMessage(text);
              console.log('📨 API Response:', response);

              // Remove thinking message
              setMessages(m => m.filter(msg => msg.id !== thinkingId));

              // Add AI response
              pushMessage('agent', response.message);

              // Check if we have wallet tokens from wallet analysis
              if (response.walletTokens && response.walletTokens.length > 0) {
                console.log('✅ Wallet tokens received:', response.walletTokens);
                // Convert wallet tokens to suggested token format for display
                const tokenSymbols = response.walletTokens.map(token => token.symbol);
                console.log('🔄 Setting suggested tokens:', tokenSymbols);
                setSuggestedTokens(tokenSymbols);

                // Store balances for later use
                const balanceMap = {};
                response.walletTokens.forEach(token => {
                  balanceMap[token.symbol] = parseFloat(token.balance).toFixed(2);
                });
                setWalletTokenBalances(balanceMap);
                console.log('💰 Stored wallet token balances:', balanceMap);
              } else {
                console.log('❌ No wallet tokens in response');
              }

              // Check if we have strategies to display
              if (response.strategies && response.strategies.length > 0) {
                // Clear suggested tokens when showing strategies
                setSuggestedTokens([]);

                // Display top 3 strategies only (no intermediate loading message)
                const topStrategies = response.strategies.slice(0, 3);
                setAvailableStrategies(topStrategies);
                setProposals(topStrategies);

                // Don't auto-create mandate - let user select strategy first
              }
            } catch (error) {
              console.error('Chat error:', error);
              setMessages(m => m.filter(msg => msg.id !== thinkingId));
              pushMessage('agent', `Sorry, I encountered an error: ${error.message}. Please try again.`);
            } finally {
              setIsLoading(false);
            }
          }

          return (
            <div className="rounded-2xl bg-bg-secondary border border-border-default p-6 shadow-lg h-full flex flex-col min-h-[600px]">

              {/* Messages area - Takes up most space, items aligned to bottom */}
              <div className="flex-1 overflow-auto flex flex-col justify-end space-y-4 pr-2">
                {messages.map(m => (
                  <div key={m.id} className="message-enter">
                    <div className={`max-w-[90%] ${m.from==='agent' ? 'bg-bg-tertiary self-start rounded-xl p-4 text-txt-primary' : 'bg-brand-pink text-white self-end rounded-xl p-4 ml-auto'}`}>
                      <div className="text-base leading-relaxed">
                        {/* Parse markdown-style lists for wallet holdings */}
                        {m.text.includes('* ') ? (
                          <div>
                            {m.text.split('\n').map((line, idx) => {
                              if (line.trim().startsWith('* ')) {
                                // Parse token amount and USD value
                                const content = line.replace('* ', '').trim();
                                return (
                                  <div key={idx} className="flex items-baseline justify-between py-1 border-b border-border-default last:border-b-0">
                                    <span className="text-txt-primary font-medium">{content.split('(')[0].trim()}</span>
                                    <span className="text-txt-secondary text-sm ml-4">{content.match(/\((.*?)\)/)?.[1] || ''}</span>
                                  </div>
                                );
                              } else {
                                return <div key={idx} className={idx === 0 ? 'mb-3 font-medium' : 'mt-2'}>{line}</div>;
                              }
                            })}
                          </div>
                        ) : (
                          <div className="flex items-center gap-2">
                            {m.text}
                            {m.successLink && (
                              <a
                                href={m.successLink.url}
                                target="_self"
                                className="text-brand-pink font-bold hover:underline inline-flex items-center"
                              >
                                {m.successLink.text}
                                <svg className="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                              </a>
                            )}
                            {m.isLoading && (
                              <div className="flex gap-1">
                                <div className="w-2 h-2 bg-brand-pink rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                <div className="w-2 h-2 bg-brand-pink rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                <div className="w-2 h-2 bg-brand-pink rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                    {m.showWalletConnect && !walletAddress && (
                      <div className="mt-2 max-w-[90%] bg-bg-tertiary self-start rounded-xl p-4 text-txt-primary">
                        <div className="text-base leading-relaxed">
                          <button
                            onClick={connectWallet}
                            disabled={isWalletConnecting}
                            className="text-brand-pink font-bold hover:underline disabled:opacity-50"
                          >
                            {isWalletConnecting ? 'Connecting...' : 'Connect your wallet'}
                          </button>
                          <span> to get started.</span>
                        </div>
                      </div>
                    )}
                    {m.strategyDetails && (
                      <div className="mt-4 bg-bg-secondary border border-border-default rounded-2xl p-6 max-w-xl shadow-lg">
                        <div className="flex items-start justify-between mb-4">
                          <div>
                            <h3 className="text-xl font-bold text-txt-primary">{m.strategyDetails.title}</h3>
                            <p className="text-sm text-txt-tertiary mt-1">{m.strategyDetails.chain} — {m.strategyDetails.strategy}</p>
                          </div>
                          <div className={`px-3 py-1 rounded-full text-xs font-semibold ${
                            m.strategyDetails.risk === 'low' ? 'bg-green-100 text-green-700' :
                            m.strategyDetails.risk === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                            'bg-red-100 text-red-700'
                          }`}>
                            {m.strategyDetails.risk.toUpperCase()}
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                          <div className="bg-bg-elevated border border-border-light p-4 rounded-xl">
                            <div className="text-xs text-txt-tertiary mb-1">Projected APY</div>
                            <div className="text-3xl font-bold text-brand-green">{m.strategyDetails.projAPY}%</div>
                          </div>
                          <div className="bg-bg-tertiary p-4 rounded-xl">
                            <div className="text-xs text-txt-secondary mb-1">TVL</div>
                            <div className="text-xl font-semibold text-txt-primary">${(m.strategyDetails.tvl / 1000000).toFixed(1)}M</div>
                          </div>
                        </div>

                        <div className="space-y-3 mb-6">
                          <div className="space-y-2">
                            <div className="flex justify-between text-sm">
                              <span className="text-txt-secondary">Deposit Amount ({m.strategyDetails.underlyingSymbol || 'Token'})</span>
                              {m.strategyDetails.userBalance && (
                                <span className="text-xs text-txt-tertiary">Balance: {m.strategyDetails.userBalance}</span>
                              )}
                            </div>
                            <input
                              type="number"
                              min="0"
                              step="0.01"
                              value={m.strategyDetails.depositAmount || ''}
                              placeholder="Enter amount to deposit"
                              onChange={(e) => {
                                const newDepositAmount = parseFloat(e.target.value) || 0;
                                const currentLeverage = m.strategyDetails.currentLeverage || m.strategyDetails.leverage;

                                // Update the message with new deposit amount
                                setMessages(msgs => msgs.map(msg => {
                                  if (msg.id === m.id && msg.strategyDetails) {
                                    return {
                                      ...msg,
                                      strategyDetails: {
                                        ...msg.strategyDetails,
                                        depositAmount: newDepositAmount,
                                        borrowAmount: newDepositAmount * (currentLeverage - 1)
                                      }
                                    };
                                  }
                                  return msg;
                                }));
                              }}
                              className="w-full px-4 py-2 rounded-lg border-2 border-border-default bg-bg-tertiary text-txt-primary placeholder-txt-tertiary focus:border-brand-pink focus:ring-2 focus:ring-brand-pink/20 text-sm"
                            />
                          </div>

                          {/* Conditional: Only show for leveraged strategies */}
                          {m.strategyDetails.strategyType === 'leveraged_credit_account' && (
                            <>
                              {m.strategyDetails.depositAmount > 0 && (
                                <div className="text-xs text-txt-tertiary">
                                  Borrow: {(m.strategyDetails.depositAmount * ((m.strategyDetails.currentLeverage || m.strategyDetails.leverage) - 1)).toFixed(2)} {m.strategyDetails.underlyingSymbol || 'Token'}
                                </div>
                              )}

                              <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                  <span className="text-txt-secondary">Leverage</span>
                                  <span className="font-semibold text-brand-pink">{m.strategyDetails.currentLeverage || m.strategyDetails.leverage}x</span>
                                </div>
                                <input
                                  type="range"
                                  min={m.strategyDetails.minLeverage || 1}
                                  max={m.strategyDetails.maxLeverage || 10}
                                  step="0.1"
                                  value={m.strategyDetails.currentLeverage || m.strategyDetails.leverage}
                                  onChange={(e) => {
                                    const newLeverage = parseFloat(e.target.value);
                                    // Recalculate APY: (collateralAPY * leverage) - (borrowAPY * (leverage - 1))
                                    const newAPY = (m.strategyDetails.collateralAPY * newLeverage) - (m.strategyDetails.borrowAPY * (newLeverage - 1));
                                    const currentDeposit = m.strategyDetails.depositAmount || 0;

                                    // Update the message with new leverage, APY, and borrow amount
                                    setMessages(msgs => msgs.map(msg => {
                                      if (msg.id === m.id && msg.strategyDetails) {
                                        return {
                                          ...msg,
                                          strategyDetails: {
                                            ...msg.strategyDetails,
                                            currentLeverage: newLeverage,
                                            projAPY: parseFloat(newAPY.toFixed(2)),
                                            borrowAmount: currentDeposit * (newLeverage - 1)
                                          }
                                        };
                                      }
                                      return msg;
                                    }));
                                  }}
                                  className="w-full h-2 bg-border-default rounded-lg appearance-none cursor-pointer accent-brand-pink"
                                  style={{ accentColor: '#EA0890' }}
                                />
                                <div className="flex justify-between text-xs text-txt-tertiary">
                                  <span>{m.strategyDetails.minLeverage || 1}x</span>
                                  <span>{m.strategyDetails.maxLeverage || 10}x</span>
                                </div>
                              </div>
                            </>
                          )}

                          {/* Info box for passive lending */}
                          {m.strategyDetails.strategyType === 'passive_lending' && (
                            <div className="p-3 rounded-lg bg-blue-50 border border-blue-200">
                              <div className="flex items-start gap-2">
                                <svg className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                                </svg>
                                <div className="flex-1">
                                  <div className="text-sm font-semibold text-blue-800">Safe Passive Lending</div>
                                  <div className="text-xs text-blue-700 mt-1">
                                    Deposit {m.strategyDetails.underlyingSymbol} into the pool to earn {m.strategyDetails.projAPY}% APY.
                                    No leverage, no liquidation risk. Withdraw anytime (subject to pool liquidity).
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                          <div className="flex justify-between text-sm">
                            <span className="text-txt-secondary">Est. Gas</span>
                            <span className="font-semibold text-txt-primary">${m.strategyDetails.estimatedGas}</span>
                          </div>
                          <div className="flex justify-between text-sm">
                            <span className="text-txt-secondary">Collateral APY</span>
                            <span className="font-semibold text-txt-primary">{m.strategyDetails.collateralAPY}%</span>
                          </div>
                        </div>

                        <button
                          onClick={async () => {
                            // Validate deposit amount
                            const depositAmount = m.strategyDetails.depositAmount;
                            if (!depositAmount || depositAmount <= 0) {
                              pushNotification({
                                title: 'Deposit amount required',
                                body: 'Please enter a deposit amount to continue.'
                              });
                              return;
                            }

                            // Clear strategy buttons
                            setAvailableStrategies([]);

                            if (m.strategyDetails.strategyType === 'passive_lending') {
                              // For passive lending: simple deposit, no health factor calculation
                              const monthlyReturn = depositAmount * m.strategyDetails.projAPY / 100 / 12;

                              pushMessage('agent', 'Ready to deposit! Review and approve.', {
                                proposalApproval: {
                                  ...m.strategyDetails,
                                  deposit: depositAmount,
                                  borrow: 0,
                                  borrowRate: 0,
                                  healthFactor: null, // No health factor for passive lending
                                  net30d: Math.round(monthlyReturn * 100) / 100,
                                  leverage: 1, // No leverage
                                  liquidationPrice: null
                                }
                              });
                            } else {
                              // For leveraged strategies: calculate health factor
                              const currentLeverage = m.strategyDetails.currentLeverage || m.strategyDetails.leverage;
                              const borrowAmount = depositAmount * (currentLeverage - 1);
                              const borrowRate = m.strategyDetails.borrowAPY;

                              // Show loading message while calculating health factor
                              const calcId = uid('m');
                              pushMessage('agent', 'Calculating position metrics...', { id: calcId, isLoading: true });

                              try {
                                // Get real liquidation threshold for the collateral token
                                const tokenSymbol = m.strategyDetails.underlyingSymbol || 'USDC';
                                const liquidationThreshold = m.strategyDetails.liquidationThresholds?.[tokenSymbol];

                                console.log('📊 Health calculation params:', {
                                  token: tokenSymbol,
                                  liquidationThreshold,
                                  borrowAPY: borrowRate,
                                  leverage: currentLeverage
                                });

                                // Call health calculation API with real LT and borrow APY
                                const response = await fetch('/api/calculate-health', {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({
                                    collateral_amount: depositAmount,
                                    collateral_token: tokenSymbol,
                                    leverage: currentLeverage,
                                    target_apy: m.strategyDetails.collateralAPY,
                                    liquidation_threshold: liquidationThreshold,
                                    borrow_apy: borrowRate
                                  })
                                });

                                const healthData = await response.json();
                                setMessages(msgs => msgs.filter(msg => msg.id !== calcId));

                                const monthlyReturn = (depositAmount * currentLeverage * m.strategyDetails.collateralAPY / 100 / 12) -
                                                     (borrowAmount * borrowRate / 100 / 12);

                                pushMessage('agent', 'Great choice! Review the details and approve when ready.', {
                                  proposalApproval: {
                                    ...m.strategyDetails,
                                    deposit: depositAmount,
                                    borrow: borrowAmount,
                                    borrowRate: borrowRate,
                                    healthFactor: healthData.healthFactor || 1.8,
                                    net30d: Math.round(monthlyReturn * 100) / 100,
                                    leverage: currentLeverage,
                                    liquidationPrice: healthData.liquidationPrice
                                  }
                                });
                              } catch (error) {
                                console.error('Health calculation error:', error);
                                setMessages(msgs => msgs.filter(msg => msg.id !== calcId));

                                const fallbackHealthFactor = 1.8;
                                const monthlyReturn = (depositAmount * currentLeverage * m.strategyDetails.collateralAPY / 100 / 12) -
                                                     (borrowAmount * borrowRate / 100 / 12);

                                pushMessage('agent', 'Great choice! Review the details and approve when ready.', {
                                  proposalApproval: {
                                    ...m.strategyDetails,
                                    deposit: depositAmount,
                                    borrow: borrowAmount,
                                    borrowRate: borrowRate,
                                    healthFactor: fallbackHealthFactor,
                                    net30d: Math.round(monthlyReturn * 100) / 100,
                                    leverage: currentLeverage
                                  }
                                });
                              }
                            }
                          }}
                          disabled={!m.strategyDetails.depositAmount || m.strategyDetails.depositAmount <= 0}
                          className="flex justify-center items-center w-full h-[40px] px-4 py-2 gap-2 flex-shrink-0 rounded-xl bg-brand-pink text-white font-bold hover:bg-[#D10780] disabled:bg-gray-400 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl"
                        >
                          {m.strategyDetails.strategyType === 'passive_lending' ? 'Deposit to Pool' : 'Open Leveraged Position'}
                        </button>
                      </div>
                    )}
                    {m.proposalApproval && (
                      <div className="mt-4 bg-bg-secondary border-2 border-border-light rounded-2xl p-6 max-w-xl shadow-xl">
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <h3 className="text-xl font-bold text-txt-primary">{m.proposalApproval.title}</h3>
                            <div className="text-sm text-txt-tertiary mt-1">{m.proposalApproval.chain} — {m.proposalApproval.strategy}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-xs text-txt-tertiary">Projected APY</div>
                            <div className="text-2xl font-bold text-brand-pink">{m.proposalApproval.projAPY}%</div>
                          </div>
                        </div>

                        <div className="bg-bg-tertiary rounded-xl p-4 mb-4">
                          <div className={`grid ${m.proposalApproval.strategyType === 'leveraged_credit_account' ? 'grid-cols-2' : 'grid-cols-1'} gap-4`}>
                            <div>
                              <div className="text-xs text-txt-secondary mb-1">
                                {m.proposalApproval.strategyType === 'passive_lending' ? 'Deposit Amount' : 'Investment'}
                              </div>
                              <div className="text-lg font-semibold text-txt-primary">${m.proposalApproval.deposit.toFixed(2)}</div>
                            </div>
                            {m.proposalApproval.strategyType === 'leveraged_credit_account' && (
                              <div>
                                <div className="text-xs text-txt-secondary mb-1">Borrow</div>
                                <div className="text-lg font-semibold text-txt-primary">
                                  ${m.proposalApproval.borrow.toFixed(2)}
                                  <span className="text-sm text-txt-tertiary"> at {m.proposalApproval.borrowRate.toFixed(2)}%</span>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>

                        <div className="space-y-3 mb-4">
                          {m.proposalApproval.strategyType === 'leveraged_credit_account' ? (
                            <>
                              <div className="flex justify-between items-center">
                                <span className="text-sm text-txt-secondary">Leverage</span>
                                <span className="text-lg font-bold text-brand-pink">{m.proposalApproval.leverage.toFixed(1)}x</span>
                              </div>
                              <div className="flex justify-between items-center">
                                <span className="text-sm text-txt-secondary">Health Factor</span>
                                <span className={`text-lg font-bold ${m.proposalApproval.healthFactor >= 1.5 ? 'text-brand-green' : 'text-yellow-600'}`}>
                                  {m.proposalApproval.healthFactor.toFixed(2)}x
                                </span>
                              </div>
                              {m.proposalApproval.liquidationPrice && (
                                <div className="flex justify-between items-center">
                                  <span className="text-sm text-txt-secondary">Liquidation Price</span>
                                  <span className="text-sm font-semibold text-txt-primary">${m.proposalApproval.liquidationPrice.toFixed(2)}</span>
                                </div>
                              )}
                            </>
                          ) : (
                            <div className="text-sm text-txt-secondary text-center py-2 bg-green-50 rounded-lg border border-green-200">
                              ✅ No liquidation risk - your funds are safely deposited in the lending pool
                            </div>
                          )}
                          <div className="flex justify-between items-center">
                            <span className="text-sm text-txt-secondary">Projected Earnings (30d)</span>
                            <span className="text-lg font-bold text-brand-green">${m.proposalApproval.net30d.toFixed(2)}</span>
                          </div>
                        </div>

                        {m.proposalApproval.strategyType === 'leveraged_credit_account' && m.proposalApproval.healthFactor < 1.5 && (
                          <div className="mb-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                            <div className="flex items-start gap-2">
                              <svg className="w-5 h-5 text-yellow-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                              </svg>
                              <div className="flex-1">
                                <div className="text-sm font-semibold text-yellow-800">Lower Health Factor</div>
                                <div className="text-xs text-yellow-700 mt-1">This position has a health factor below 1.5x. Consider reducing leverage to lower liquidation risk.</div>
                              </div>
                            </div>
                          </div>
                        )}

                        <button
                          onClick={() => {
                            approveProposal(m.proposalApproval.id, m.proposalApproval.deposit);
                          }}
                          className="flex justify-center items-center w-full h-[40px] px-4 py-2 gap-2 flex-shrink-0 rounded-xl bg-brand-green text-white font-bold hover:bg-[#1EB050] transition-all shadow-lg hover:shadow-xl"
                        >
                          Approve & Sign
                        </button>
                      </div>
                    )}
                  </div>
                ))}
              </div>

              {/* Quick reply cards - Above input */}
              {quickReplies.length > 0 && (
                <div className="grid grid-cols-4 gap-2 mb-3 mt-3">
                  {quickReplies.map((q, idx) => (
                    <button
                      key={q.label}
                      onClick={async () => {
                        if (q.isStrategy) {
                          // Get balance from stored wallet token balances
                          const tokenSymbol = q.strategy.underlyingSymbol || 'USDC';
                          const userBalance = walletTokenBalances[tokenSymbol] || '0.00';
                          console.log(`💰 Using stored balance for ${tokenSymbol}:`, userBalance);

                          // Show strategy details inline in chat with balance
                          pushMessage('agent', `Here are the details for ${q.strategy.title}:`, {
                            strategyDetails: {
                              ...q.strategy,
                              userBalance: userBalance
                            }
                          });
                        } else if (q.isAlert) {
                          // Create mandate to monitor for better rates
                          if (availableStrategies.length > 0) {
                            // Get the best strategy's details to create mandate
                            const bestStrategy = availableStrategies[0];

                            // Create mandate based on current search
                            const asset = bestStrategy.underlyingToken || 'USDC';
                            const currentBestAPY = bestStrategy.projAPY;

                            // Request notification permission
                            if ('Notification' in window && Notification.permission === 'default') {
                              Notification.requestPermission().then(permission => {
                                if (permission === 'granted') {
                                  pushMessage('agent', 'Great! Browser notifications enabled. I\'ll alert you when better rates appear.');

                                  // Send a test notification
                                  setTimeout(() => {
                                    new Notification('Sigma - Alert Created! 🎯', {
                                      body: `Monitoring ${asset} opportunities. You'll be notified when rates improve above ${currentBestAPY + 2}% APY.`,
                                      icon: '/logo.png',
                                      badge: '/logo.png',
                                      tag: 'mandate-created'
                                    });
                                  }, 500);
                                } else if (permission === 'denied') {
                                  pushMessage('agent', 'No worries! I\'ll still track opportunities for you. You can check back here anytime to see updates.');
                                }
                              });
                            } else if (Notification.permission === 'granted') {
                              // Permission already granted, send test notification
                              setTimeout(() => {
                                new Notification('Sigma - Alert Created! 🎯', {
                                  body: `Monitoring ${asset} opportunities. You'll be notified when rates improve above ${currentBestAPY + 2}% APY.`,
                                  icon: '/logo.png',
                                  badge: '/logo.png',
                                  tag: 'mandate-created'
                                });
                              }, 500);
                            }

                            createMandateFromIntent({
                              asset,
                              minAPY: currentBestAPY + 2, // Look for 2% better than current best
                              maxLeverage: bestStrategy.maxLeverage || 10,
                              risk: bestStrategy.risk,
                              maxPosition: 10000
                            });

                            // Clear strategy buttons
                            setAvailableStrategies([]);

                            const notificationStatus = Notification.permission === 'granted'
                              ? 'I\'ll send you a browser notification'
                              : 'Check back here for updates';

                            pushMessage('agent', `Perfect! I've created a mandate to monitor these opportunities. ${notificationStatus} when rates improve above ${currentBestAPY + 2}% APY or when better strategies appear.`);
                          } else {
                            pushMessage('agent', 'No strategies to save right now. Search for opportunities first, then you can set alerts on them!');
                          }
                        } else {
                          // Regular text-based quick reply
                          setInput(q.text);
                          handleSend(q.text);
                        }
                      }}
                      className={`flex flex-col items-center justify-center p-3 rounded-lg bg-bg-tertiary hover:bg-bg-elevated border border-border-default hover:border-brand-pink transition-all group ${q.isStrategy ? 'button-enter strategy-button' : ''}`}
                    >
                      <div className="mb-2 text-white" dangerouslySetInnerHTML={{ __html: q.iconSvg }}></div>
                      <div className="text-xs font-semibold text-txt-primary mb-0.5">{q.label}</div>
                      <div className="text-[10px] text-txt-tertiary text-center leading-tight">{q.description}</div>
                    </button>
                  ))}
                </div>
              )}

              {/* Input field at BOTTOM like normal chat */}
              <div className="border-t pt-4 mt-auto">
                <div className="flex gap-3">
                  <input
                    value={input}
                    onChange={(e)=>setInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && !isLoading && handleSend(input)}
                    placeholder="Type your investment goal or question..."
                    disabled={isLoading}
                    className="flex-1 h-[40px] px-4 py-2 rounded-xl border-2 border-border-default bg-bg-tertiary text-txt-primary placeholder-txt-tertiary focus:border-brand-pink focus:ring-2 focus:ring-brand-pink/20 text-base disabled:bg-bg-tertiary disabled:cursor-not-allowed transition-all outline-none"
                  />
                  <button
                    onClick={()=>handleSend(input)}
                    disabled={isLoading}
                    className="flex justify-center items-center w-[336px] h-[40px] px-4 py-2 gap-2 flex-shrink-0 rounded-xl bg-brand-pink text-white hover:bg-[#D10780] text-base font-bold disabled:bg-bg-tertiary disabled:text-txt-tertiary disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl"
                  >
                    {isLoading ? (
                      <>
                        <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Sending...
                      </>
                    ) : (
                      <>
                        <span>Send</span>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          );
        }

        /* ----------------------------
           SignMandate (inline preview + modal)
           ----------------------------*/
        function SignMandatePanel({mandate}){
          const { signMandateWithWallet } = useApp();
          const [open,setOpen] = useState(false);
          const [loading,setLoading] = useState(false);

          if(!mandate) return null;

          const handleSign = async ()=>{
            setLoading(true);
            await signMandateWithWallet(mandate.id);
            setLoading(false);
            setOpen(false);
          }

          return (
            <div className="rounded-2xl bg-bg-secondary p-4 shadow-sm">
              <div className="flex items-start justify-between">
                <div>
                  <div className="text-sm font-semibold">Mandate preview</div>
                  <div className="text-xs text-txt-tertiary">Drafted from your conversation — edit or sign.</div>
                </div>
                <div className="flex gap-2">
                  <button onClick={()=>setOpen(true)} className="px-3 py-1 rounded bg-indigo-600 text-white text-sm">Sign</button>
                </div>
              </div>

              <div className="mt-3 grid grid-cols-2 gap-2">
                <div className="text-xs text-txt-tertiary">Asset</div><div className="font-medium">{mandate.asset}</div>
                <div className="text-xs text-txt-tertiary">Min APY</div><div className="font-medium">{mandate.minAPY}%</div>
                <div className="text-xs text-txt-tertiary">Max Leverage</div><div className="font-medium">{mandate.maxLeverage}x</div>
                <div className="text-xs text-txt-tertiary">Risk</div><div className="font-medium">{mandate.risk}</div>
                <div className="text-xs text-txt-tertiary">Max Position</div><div className="font-medium">${mandate.maxPosition}</div>
              </div>

              {/* modal simplified */}
              {open && (
                <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/40">
                  <div className="w-full max-w-lg bg-bg-secondary rounded-2xl p-6">
                    <h3 className="text-lg font-semibold">Sign Mandate</h3>
                    <p className="text-sm text-txt-secondary mt-2">This signs an intent message — nothing will move without your approval.</p>

                    <div className="mt-4 flex gap-2 justify-end">
                      <button onClick={()=>setOpen(false)} className="px-3 py-2 rounded border">Cancel</button>
                      <button onClick={handleSign} disabled={loading} className={`px-3 py-2 rounded ${loading ? 'bg-indigo-300' : 'bg-indigo-600 text-white'}`}>{loading ? 'Signing...' : 'Sign & Activate'}</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        /* ----------------------------
           Proposal / Tx components (lightweight)
           ----------------------------*/
        function ProposalCard({p, onView}){
          return (
            <div className="rounded-lg border p-3 bg-bg-secondary">
              <div className="flex items-start justify-between">
                <div>
                  <div className="text-sm font-semibold">{p.title}</div>
                  <div className="text-xs text-txt-tertiary">{p.strategy} • {p.chain}</div>
                </div>
                <div className="text-right">
                  <div className="font-semibold">{p.projAPY}%</div>
                  <div className="text-xs text-txt-tertiary">{p.leverage}x</div>
                </div>
              </div>

              <div className="mt-3 flex items-center justify-between">
                <div className="text-xs text-txt-tertiary">Est. gas: ${p.estimatedGas}</div>
                <button onClick={()=>onView(p)} className="px-3 py-1 rounded bg-indigo-600 text-white text-sm">View</button>
              </div>
            </div>
          );
        }

        function ProposalDetailPanel({proposal}){
          const { approveProposal } = useApp();
          if(!proposal) return null;
          return (
            <div className="rounded-2xl bg-bg-secondary p-6 shadow-sm">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-semibold">{proposal.title}</h3>
                  <div className="text-xs text-txt-tertiary">{proposal.chain} — {proposal.strategy}</div>
                </div>
                <div className="text-right">
                  <div className="text-sm text-txt-tertiary">Projected APY</div>
                  <div className="text-2xl font-semibold">{proposal.projAPY}%</div>
                </div>
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Field label="Investment">${proposal.deposit}</Field>
                  <Field label="Borrow">${proposal.borrow} at {proposal.borrowRate}%</Field>
                  <Field label="Health Factor">{proposal.healthFactor}x</Field>
                </div>
                <div>
                  <div className="text-sm text-txt-tertiary">Projected net (30d)</div>
                  <div className="text-2xl font-semibold">${proposal.net30d}</div>

                  <div className="mt-4 flex gap-2 justify-end">
                    <button onClick={()=>approveProposal(proposal.id)} className="px-4 py-2 rounded bg-indigo-600 text-white">Approve & Sign</button>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        function TxProgressPanel({txId}){
          // Only show when transaction is active - no empty state needed
          if(!txId) return null;
          return (
            <div className="rounded-2xl bg-bg-secondary p-4 shadow-sm">
              <div className="text-sm font-semibold">Transaction Progress</div>
              <div className="mt-2 text-xs text-txt-tertiary">Tx: <span className="font-mono">{txId}</span></div>
              <div className="mt-3 space-y-2">
                <div className="flex items-center justify-between"><div>Open credit account</div><div className="text-xs text-brand-green">✓</div></div>
                <div className="flex items-center justify-between"><div>Deposit collateral</div><div className="text-xs text-brand-green">✓</div></div>
                <div className="flex items-center justify-between"><div>Swap & Stake</div><div className="text-xs text-yellow-600">Pending</div></div>
              </div>
            </div>
          );
        }

        /* ----------------------------
           App logic (limited opportunities, chat-driven mandates)
           ----------------------------*/
        function FullFlowApp(){
          const templates = [
            { id: 'tmpl_stable', name: 'Stablecoin Yield (Conservative)', intentKeyword: 'stablecoins', asset: 'USDC', minAPY: 4.5, maxLeverage: 1.5, risk: 'Low', maxPosition: 5000 },
            { id: 'tmpl_eth_max', name: 'ETH Max Yield (Aggressive)', intentKeyword: 'eth', asset: 'wstETH', minAPY: 9, maxLeverage: 3, risk: 'High', maxPosition: 20000 },
            { id: 'tmpl_balanced', name: 'Balanced (Auto)', intentKeyword: 'balanced', asset: 'USDC', minAPY: 6.5, maxLeverage: 2, risk: 'Medium', maxPosition: 10000 },
          ];

          const [mandates, setMandates] = useState([]);
          const [activeMandate, setActiveMandate] = useState(null);
          const [proposals, setProposals] = useState([]); // limited to 3
          const [activeProposal, setActiveProposal] = useState(null);
          const [positions, setPositions] = useState([]);
          const [notifications, setNotifications] = useState([]);
          const [activeTx, setActiveTx] = useState(null);
          const [isScanning, setIsScanning] = useState(false);
          const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
          const [walletAddress, setWalletAddress] = useState(null);
          const [isWalletConnecting, setIsWalletConnecting] = useState(false);

          function pushNotification(n){ const note = { id: uid('n'), ...n }; setNotifications(s=>[note,...s]); setTimeout(()=>setNotifications(s=>s.filter(x=>x.id!==note.id)),7000); }

          // Wallet connection using window.ethereum (MetaMask)
          async function connectWallet() {
            if (!window.ethereum) {
              pushNotification({ title: 'Wallet not found', body: 'Please install MetaMask to connect your wallet.' });
              return;
            }

            setIsWalletConnecting(true);
            try {
              const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
              const address = accounts[0];
              setWalletAddress(address);

              pushNotification({
                title: 'Wallet connected',
                body: `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`
              });

              // Trigger auto-analysis after successful connection
              if (window.onWalletConnected) {
                setTimeout(() => window.onWalletConnected(address), 500);
              }
            } catch (error) {
              console.error('Wallet connection error:', error);
              pushNotification({ title: 'Connection failed', body: 'Could not connect to wallet.' });
            } finally {
              setIsWalletConnecting(false);
            }
          }

          function disconnectWallet() {
            setWalletAddress(null);
            pushNotification({ title: 'Wallet disconnected', body: 'Your wallet has been disconnected.' });
          }

          // Auto-connect if already authorized
          React.useEffect(() => {
            if (window.ethereum) {
              window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                  if (accounts.length > 0) {
                    setWalletAddress(accounts[0]);
                  }
                })
                .catch(console.error);

              // Listen for account changes
              window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                  setWalletAddress(accounts[0]);
                  pushNotification({ title: 'Account changed', body: 'Wallet account updated.' });
                } else {
                  setWalletAddress(null);
                }
              });
            }
          }, []);

          function createMandateFromIntent(template=null, opts={}){
            const base = template ? template : { asset: 'USDC', minAPY:6.5, maxLeverage:2, risk:'Medium', maxPosition:10000 };
            const m = {
              id: uid('mandate'),
              ...base,
              ...opts.freeText && { note: opts.freeText },
              signed: false,
              createdAt: Date.now(),
              expiresAt: Date.now()+1000*60*60*24*30,
            };
            setMandates(s=>[m,...s]);
            setActiveMandate(m);
            pushNotification({ title: 'Mandate drafted', body: `${m.asset} — ${m.risk}` });

            // NOTE: Proposals now come from real Gearbox SDK via API
            // generateMockProposals(m) is no longer needed
          }

          async function signMandateWithWallet(id){
            await new Promise(r=>setTimeout(r,700));
            setMandates(s=>s.map(m=> m.id===id? {...m, signed:true, signedAt:Date.now() }: m));
            pushNotification({ title: 'Mandate signed', body: 'Agent will monitor and propose.' });
          }

          function generateMockProposals(mandate){
            // Show scanning state first
            setIsScanning(true);

            // produce up to 3 curated proposals tailored to the mandate (deterministic-ish)
            setTimeout(() => {
              const pool = [];
              if(mandate.asset.toLowerCase().includes('usdc')){
                pool.push({ id: uid('p'), title: 'USDC Yield Curve Pool', chain: 'Ethereum', strategy: 'Curve + Gearbox', projAPY: 6.8, collateralAPY: 2.5, deposit: Math.min(10000, mandate.maxPosition), borrow: 8000, leverage: 1.8, maxLeverage: mandate.maxLeverage, healthFactor:2.3, estimatedGas: 12, net30d: 42, borrowRate: 4.2 });
                pool.push({ id: uid('p'), title: 'Stable AAA Lending', chain: 'Base', strategy: 'Lending + leverage', projAPY: 7.1, collateralAPY: 2.1, deposit: Math.min(8000, mandate.maxPosition), borrow: 6000, leverage: 1.75, maxLeverage: mandate.maxLeverage, healthFactor:2.0, estimatedGas: 8, net30d: 38, borrowRate: 3.9 });
              }
              if(mandate.asset.toLowerCase().includes('wst') || mandate.asset.toLowerCase().includes('eth')){
                pool.push({ id: uid('p'), title: 'wstETH Lido Boost', chain: 'Ethereum', strategy: 'Lido + Curve', projAPY: 8.9, collateralAPY: 3.3, deposit: Math.min(10000, mandate.maxPosition), borrow: 15000, leverage: Math.min(2.8, mandate.maxLeverage), maxLeverage: mandate.maxLeverage, healthFactor:1.95, estimatedGas: 22, net30d: 65, borrowRate: 5.1 });
              }

              // ensure max 3 proposals and short-circuit duplicates
              const curated = pool.slice(0,3);
              setProposals(curated);
              setIsScanning(false);
              pushNotification({ title: 'Opportunities ready', body: `Found ${curated.length} matches for your mandate.` });
            }, 2000); // Simulate scanning delay
          }

          function openProposal(p){ setActiveProposal(p); }

          async function approveProposal(id, depositAmount){
            const p = proposals.find(x=>x.id===id);
            if(!p) return;

            // Validate wallet connection
            if (!walletAddress) {
              pushNotification({ title: 'Wallet not connected', body: 'Please connect your wallet first.' });
              return;
            }

            // Validate deposit amount
            if (!depositAmount || depositAmount <= 0) {
              pushNotification({ title: 'Invalid deposit', body: 'Please enter a valid deposit amount.' });
              return;
            }

            // Extract deposit parameters
            const poolAddress = p.poolAddress;
            const tokenAddress = p.underlyingToken;
            const tokenSymbol = p.underlyingSymbol || 'Token';
            const amount = depositAmount.toString();

            console.log('🚀 Starting real deposit transaction:', {
              pool: poolAddress,
              token: tokenAddress,
              symbol: tokenSymbol,
              amount,
              user: walletAddress
            });

            try {
              // Check ethers.js is loaded
              if (!window.ethers) {
                throw new Error('Ethers.js not loaded. Please refresh the page.');
              }

              // Check MetaMask/wallet is installed
              if (!window.ethereum) {
                throw new Error('Please install MetaMask or another Web3 wallet');
              }

              // Get provider and signer from MetaMask
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              const signer = provider.getSigner();

              // ERC20 ABI for token interactions
              const erc20Abi = [
                'function decimals() view returns (uint8)',
                'function allowance(address owner, address spender) view returns (uint256)',
                'function approve(address spender, uint256 amount) returns (bool)',
              ];

              // Pool ABI for deposit
              const poolAbi = [
                'function depositWithReferral(uint256 assets, address receiver, uint256 referralCode) returns (uint256)',
              ];

              // Step 1: Get token decimals
              const tokenContract = new ethers.Contract(tokenAddress, erc20Abi, signer);
              const decimals = await tokenContract.decimals();
              console.log(`💰 Token decimals: ${decimals}`);

              // Step 2: Convert amount to wei
              const amountWei = ethers.utils.parseUnits(amount, decimals);
              console.log(`💰 Amount in wei: ${amountWei.toString()}`);

              // Step 3: Check existing allowance
              const currentAllowance = await tokenContract.allowance(walletAddress, poolAddress);
              console.log(`✅ Current allowance: ${currentAllowance.toString()}`);

              let approvalTx;

              // Step 4: Approve if needed (use infinite approval for gas savings)
              if (currentAllowance.lt(amountWei)) {
                pushNotification({ title: 'Approval required', body: `Approving ${tokenSymbol} for deposit...` });
                console.log('🔐 Approving pool for infinite amount...');

                const maxUint256 = ethers.constants.MaxUint256;
                approvalTx = await tokenContract.approve(poolAddress, maxUint256);

                console.log(`⏳ Approval pending: ${approvalTx.hash}`);
                pushNotification({ title: 'Waiting for approval', body: `Transaction: ${approvalTx.hash.slice(0, 10)}...` });

                // Wait for approval confirmation
                await approvalTx.wait();
                console.log(`✅ Approval confirmed: ${approvalTx.hash}`);
                pushNotification({ title: 'Approval confirmed', body: 'Now depositing...' });
              } else {
                console.log('✅ Sufficient allowance already exists');
              }

              // Step 5: Deposit into pool using depositWithReferral
              console.log('💸 Depositing into pool...');
              pushNotification({ title: 'Deposit starting', body: `Depositing ${amount} ${tokenSymbol}...` });

              const poolContract = new ethers.Contract(poolAddress, poolAbi, signer);
              const depositTx = await poolContract.depositWithReferral(
                amountWei,
                walletAddress,
                0 // referral code
              );

              setActiveTx(depositTx.hash);
              setProposals([]); // clear feed after user commits (clean UX)
              console.log(`⏳ Deposit pending: ${depositTx.hash}`);
              pushNotification({ title: 'Deposit submitted', body: `Transaction: ${depositTx.hash.slice(0, 10)}...` });

              // Wait for deposit confirmation
              const receipt = await depositTx.wait();
              console.log(`✅ Deposit confirmed: ${depositTx.hash}`);

              // Step 6: Parse shares from Transfer event logs
              const transferEventSignature = '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef';
              const transferLog = receipt.logs.find(
                (log) =>
                  log.topics[0] === transferEventSignature &&
                  log.topics[1] === '0x0000000000000000000000000000000000000000000000000000000000000000' && // from 0x0
                  log.topics[2]?.toLowerCase().includes(walletAddress.toLowerCase().slice(2)) // to user
              );

              let shares = '0';
              if (transferLog && transferLog.data) {
                const sharesWei = ethers.BigNumber.from(transferLog.data);
                shares = ethers.utils.formatUnits(sharesWei, decimals);
                console.log(`🎉 Shares received: ${shares}`);
              } else {
                console.warn('⚠️ Could not parse shares from logs');
              }

              // Create position
              const pos = {
                id: uid('pos'),
                title: p.title,
                value: depositAmount,
                healthFactor: '∞', // Passive lending has no liquidation risk
                txId: depositTx.hash,
                shares: shares
              };
              setPositions(s=>[pos,...s]);
              pushNotification({ title: 'Deposit successful!', body: `Received ${parseFloat(shares).toFixed(4)} pool tokens` });

              // Add success message with link to Gearbox dashboard
              setTimeout(() => {
                pushMessage('agent', 'Deposit complete! Your position is now active. View and manage your positions on the ', {
                  successLink: {
                    url: 'https://app.gearbox.fi/dashboard',
                    text: 'Gearbox Dashboard'
                  }
                });
              }, 500);

              setTimeout(()=> setActiveTx(null), 2000);

            } catch (error) {
              console.error('❌ Deposit transaction failed:', error);
              setActiveTx(null);
              pushNotification({
                title: 'Transaction failed',
                body: error.message || 'Please try again'
              });
            }
          }

          function closePosition(id){ setPositions(s=>s.filter(p=>p.id!==id)); pushNotification({ title: 'Position closed', body: 'Closed successfully.' }); }

          const value = useMemo(()=>({
            templates,
            createMandateFromIntent,
            mandates,
            signMandateWithWallet,
            proposals,
            openProposal,
            approveProposal,
            positions,
            closePosition,
            notifications,
            pushNotification,
            isScanning,
            activeMandate,
            walletAddress,
            connectWallet,
            disconnectWallet,
            isWalletConnecting,
            setProposals
          }), [templates, mandates, proposals, positions, notifications, isScanning, activeMandate, walletAddress, isWalletConnecting]);

          return (
            <AppContext.Provider value={value}>
              <div className="min-h-screen bg-bg-primary py-10">
                <div className="max-w-7xl mx-auto px-4">
                  {/* Header with Wallet Connection */}
                  <div className="mb-6 flex items-center justify-between max-w-5xl mx-auto">
                    <div className="flex items-center gap-3">
                      {/* Robot Logo */}
                      <div className="flex-shrink-0">
                        <img src="/logo.png" alt="Sigma Logo" className="w-12 h-12" />
                      </div>
                      <div>
                        <div className="text-2xl font-bold text-brand-pink">Sigma</div>
                        <div className="text-xs text-txt-tertiary">The High-Yield Lending Specialist</div>
                      </div>
                    </div>

                    {/* Wallet Status Display (connected only) */}
                    {walletAddress && (
                      <div className="flex items-center gap-3">
                        <div className="px-4 py-2 rounded-lg bg-bg-elevated border border-border-default text-sm font-medium text-brand-green flex items-center gap-2">
                          <div className="w-2 h-2 rounded-full bg-brand-green"></div>
                          {walletAddress.slice(0, 6)}...{walletAddress.slice(-4)}
                        </div>
                        <button
                          onClick={disconnectWallet}
                          className="flex justify-center items-center h-[40px] px-4 py-2 gap-2 flex-shrink-0 rounded-lg bg-bg-secondary border border-border-default hover:bg-bg-tertiary text-sm font-medium text-txt-primary"
                        >
                          Disconnect
                        </button>
                      </div>
                    )}
                  </div>

                  {/* FULL-WIDTH CHAT-FIRST LAYOUT */}
                  <div className="max-w-5xl mx-auto space-y-6">
                    {/* Chat Interface - Primary, Full Width */}
                    <div className="min-h-[600px]">
                      <ChatPanel />
                    </div>

                    {/* Mandate Preview - HIDDEN (mandates now work in background) */}
                    {/* {activeMandate && (
                      <SignMandatePanel mandate={activeMandate} />
                    )} */}

                    {/* Strategies Section - HIDDEN (now shown as quick reply buttons in chat) */}
                    {false && (
                    <div className="space-y-4">
                    <div id="strategies-section" className="rounded-2xl p-4 bg-bg-secondary shadow-sm">
                      <div className="flex items-center justify-between mb-4">
                        <div>
                          <h3 className="text-lg font-semibold">Strategies for You</h3>
                          <p className="text-xs text-txt-tertiary">
                            {proposals.length > 0
                              ? `${proposals.length} high-yield opportunities ready to review`
                              : activeMandate
                                ? 'Finding the best matches for your mandate...'
                                : 'Create a mandate to start finding opportunities'}
                          </p>
                        </div>
                        {proposals.length > 0 && (
                          <div className="flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-bg-elevated0"></div>
                            <div className="text-xs text-txt-tertiary">Last scan: just now</div>
                          </div>
                        )}
                      </div>

                      {proposals.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                          {proposals.map(p => <ProposalCard key={p.id} p={p} onView={openProposal} />)}
                        </div>
                      ) : (
                        <OpportunityEmptyState
                          hasMandate={!!activeMandate}
                          isScanning={isScanning}
                          onCreateMandate={() => {
                            // Focus on the input field in chat
                            pushNotification({ title: 'Getting started', body: 'Use the assistant to describe your investment goals.' });
                          }}
                        />
                      )}
                    </div>
                    </div>
                    )}
                    {/* End of hidden strategies section */}

                    {activeProposal && <ProposalDetailPanel proposal={activeProposal} />}

                    {/* Transaction Progress and Positions - only show when active */}
                    <div className="space-y-4">
                      {activeTx && <TxProgressPanel txId={activeTx} />}

                      {positions.length > 0 && (
                        <div className="rounded-2xl bg-bg-secondary p-4 shadow-sm">
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-sm font-semibold">Active Positions</div>
                            <div className="text-xs text-txt-tertiary">{positions.length} position{positions.length !== 1 ? 's' : ''}</div>
                          </div>
                          <div className="space-y-3">
                            {positions.map(p => (
                              <div key={p.id} className="flex items-center justify-between border rounded-lg p-3 hover:border-gray-300 transition-colors">
                                <div>
                                  <div className="text-sm font-semibold">{p.title}</div>
                                  <div className="text-xs text-txt-tertiary">Value: ${p.value.toLocaleString()} • Health: {p.healthFactor}x</div>
                                </div>
                                <div className="flex gap-2">
                                  <button onClick={()=>closePosition(p.id)} className="px-3 py-1.5 rounded-lg border border-border-default hover:border-red-300 hover:bg-red-50 text-sm transition-colors">Close</button>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Notifications */}
                  <div className="fixed right-6 bottom-6 w-96 space-y-3 z-50">
                    {/** Simple notifications list */}
                    {value.notifications && value.notifications.map(n => (
                      <div key={n.id} className="rounded-lg border border-border-default bg-bg-secondary p-3 shadow-lg">
                        <div className="flex items-start justify-between">
                          <div>
                            <div className="text-sm font-semibold text-txt-primary">{n.title}</div>
                            <div className="text-xs text-txt-secondary mt-1">{n.body}</div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </AppContext.Provider>
          );
        }

        // Wait for ethers to load, then initialize web3 config
        let initAttempts = 0;
        const MAX_INIT_ATTEMPTS = 50; // 5 seconds max

        function initializeWeb3Config() {
          initAttempts++;

          if (typeof window.initWeb3 === 'function' && window.ethers) {
            try {
              window.web3Config = window.initWeb3();
              console.log('✅ Web3 config initialized with ethers.js after', initAttempts, 'attempts');
            } catch (error) {
              console.error('❌ Failed to initialize web3 config:', error);
            }
          } else if (initAttempts < MAX_INIT_ATTEMPTS) {
            if (initAttempts === 1) {
              console.log('⏳ Waiting for ethers.js to load...');
            }
            setTimeout(initializeWeb3Config, 100); // Retry in 100ms
          } else {
            console.error('❌ Ethers.js failed to load after 5 seconds');
            console.log('window.ethers:', window.ethers);
          }
        }

        // Start initialization check
        initializeWeb3Config();

        // Render the app (will work without wallet initially, lazy-load config on deposit)
        const root = createRoot(document.getElementById('root'));
        root.render(
            <StrictMode>
                <FullFlowApp />
            </StrictMode>
        );
    </script>
</body>
</html>
